---
title: "Ovitrap vs. BG-trap Comparison"
author: "Elisabeth Nelson"
date: "2025-02-12"
output: html_document
---
## Packages 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(tidyverse)
library(lubridate)
library(readr)
library(viridis)
library(gam)
library(MASS)
library(betareg)
library(stats)
library(gamlss)
library(gamlss.dist)
library(rjags)
library(zoib)
library(lme4)
library(glmmTMB)
library(weights)
library(purrr)

```

## Data
```{r - import data}
ovitrap_results <- read_csv("ovitrap_results.csv")
bgtrap_results <- read_csv("bgtrap_results.csv")

```

## Descriptive Analyses 
### Ovitrap Results 
```{r - ovitrap descriptive}
## ensure data is in the right format and filter out <1 larvae tested
ovitrap_results_2 <- ovitrap_results %>%
  mutate(time_point = as.factor(time_point), 
         month = factor(month, levels = c("March", "April", "May"), ordered = T),
         cluster = factor(cluster, levels = c("A", "B", "C", "D", "E", "F", "G", 
                                              "H", "I", "J", "K", "L"), 
                          ordered = T), 
         trap_prop = n_wmel/n_aeg) %>%
  filter(n_larvae_tested > 0)

## look at excluded data 
ovitrap_results_excluded <- ovitrap_results %>%
  mutate(time_point = as.factor(time_point), 
         month = factor(month, levels = c("March", "April", "May"), ordered = T), 
         cluster = factor(cluster, levels = c("A", "B", "C", "D", "E", "F", "G", 
                                              "H", "I", "J", "K", "L"), 
                          ordered = T), 
         trap_prop = n_wmel/n_aeg) %>%
 filter(n_larvae_tested == 0) 

ovitrap_results_excluded %>%
  group_by(month) %>%
  summarize(n = n())

## visualize distribution
ggplot(ovitrap_results_2)+
  geom_point(aes(trap, n_larvae, group = month))+
  facet_wrap(~month)

## total larvae collected and tested
### all 
ovitrap_results_2 %>%
  ungroup()%>%
  summarize(tot_larvae = sum(n_larvae), 
            tot_larvae_tested = sum(n_larvae_tested), 
            tot_wmel = sum(n_wmel),
            tot_wt = sum(n_wt), 
            tot_aeg = sum(n_aeg), 
            tot_alb = sum(n_alb))

### by month
ovitrap_results_2 %>%
  group_by(month) %>%
    summarize(tot_larvae = sum(n_larvae), 
            tot_larvae_tested = sum(n_larvae_tested), 
            tot_wmel = sum(n_wmel),
            tot_wt = sum(n_wt), 
            tot_aeg = sum(n_aeg), 
            tot_alb = sum(n_alb))

### by time point
ovitrap_results_2 %>%
  group_by(time_point) %>%
    summarize(tot_larvae = sum(n_larvae), 
            tot_larvae_tested = sum(n_larvae_tested), 
            tot_wmel = sum(n_wmel),
            tot_wt = sum(n_wt), 
            tot_aeg = sum(n_aeg), 
            tot_alb = sum(n_alb))

### by cluster
ovitrap_results_2 %>%
  group_by(cluster) %>%
    summarize(tot_larvae = sum(n_larvae), 
            tot_larvae_tested = sum(n_larvae_tested), 
            tot_wmel = sum(n_wmel),
            tot_wt = sum(n_wt), 
            tot_aeg = sum(n_aeg), 
            tot_alb = sum(n_alb))

## total larvae collected vs. tested by cluster and time point
ovitrap_results_cluster_summ <- ovitrap_results_2 %>%
  group_by(cluster, month) %>%
  summarize(tot_larvae = sum(n_larvae), 
            tot_larvae_tested = sum(n_larvae_tested), 
            tot_wmel = sum(n_wmel))

### plot
ggplot(ovitrap_results_cluster_summ)+
  geom_col(aes(cluster, tot_larvae, group = month, color = cluster, 
               fill = cluster))+
  scale_color_viridis(discrete = T, option = "viridis")+
  scale_fill_viridis(discrete = T, option = "viridis")+
  facet_wrap(~month)+
  xlab("Cluster")+
  ylab("Larvae Tested")+
  labs(title = "Total Larvae Tested Collected")+
  ylim(0, 500)+
  theme_classic()

## visualize Wolbachia prevalences
ggplot(ovitrap_results_2, aes(trap_prop))+
  geom_histogram(fill = "lightblue", color = "navy")+
  xlim(0, 1)+
  ylim(0, 5)+
  theme_classic()+
  xlab("Oviposition Trap Proportion")+
  ylab("Count")

## proportions by cluster
ovitrap_results_3 <- ovitrap_results_2 %>%
  group_by(cluster) %>%
  summarize(wmel_cluster_tot = sum(n_wmel), 
            wt_cluster_tot = sum(n_wt), 
            aeg_cluster_tot = sum(n_aeg), 
            alb_cluster_tot = sum(n_alb), 
            cluster_tot_tested = sum(n_larvae_tested), 
            avg_cluster_prop = mean(trap_prop, na.rm = T), 
            sd_cluster_prop = sd(trap_prop, na.rm = T)) %>%
  ungroup()

### add binomial confidence intervals
ovitrap_results_3$lower_CI <- NA
ovitrap_results_3$upper_CI <- NA

for(i in 1:nrow(ovitrap_results_3)){
  prop <- ovitrap_results_3$avg_cluster_prop[i]
  tot_tested <- ovitrap_results_3$cluster_tot_tested[i]
  
  conf <- prop.test(x = prop*tot_tested, n = tot_tested, conf.level = 0.95, correct = F)
  
  ovitrap_results_3$lower_CI[i] <- conf$conf.int[[1]]
  ovitrap_results_3$upper_CI[i] <- conf$conf.int[[2]]
}

ovitrap_results_3 <- as.data.frame(ovitrap_results_3)

## proportions by cluster and time point
ovitrap_results_4 <- ovitrap_results_2 %>%
  group_by(cluster, month) %>%
  summarize(wmel_cluster_tot = sum(n_wmel), 
            wt_cluster_tot = sum(n_wt), 
            aeg_cluster_tot = sum(n_aeg), 
            alb_cluster_tot = sum(n_alb), 
            cluster_tot_tested = sum(n_larvae_tested), 
            avg_cluster_prop = mean(trap_prop, na.rm = T), 
            sd_cluster_prop = sd(trap_prop, na.rm = T)) %>%
  ungroup()

### add confidence intervals
ovitrap_results_4$lower_CI <- NA
ovitrap_results_4$upper_CI <- NA

for(i in 1:nrow(ovitrap_results_4)){
  prop <- ovitrap_results_4$avg_cluster_prop[i]
  tot_tested <- ovitrap_results_4$cluster_tot_tested[i]
  
  conf <- prop.test(x = prop*tot_tested, n = tot_tested, conf.level = 0.95, correct = F)
  
  ovitrap_results_4$lower_CI[i] <- conf$conf.int[[1]]
  ovitrap_results_4$upper_CI[i] <- conf$conf.int[[2]]
}

ovitrap_results_4 <- as.data.frame(ovitrap_results_4)

ovitrap_results_4 <- ovitrap_results_4 %>%
  mutate(month = tolower(month),
         month = factor(month, levels = c("march", "april", "may"), ordered = T)) %>%
  arrange(cluster, month)

### plot
ggplot(ovitrap_results_4, aes(month, avg_cluster_prop, group = cluster, color = cluster))+
  geom_line()+
  geom_errorbar(aes(ymin = lower_CI, ymax = upper_CI, width = 0.2))+
  geom_point()+
  scale_color_viridis(discrete = T, option = "viridis")+
  theme_bw()+
  xlab("Time Point")+
  ylab("Proportion Aedes aegypti wMel Positive")+
  labs(title = "Ovitrap Prevalence")

### histogram
ggplot(ovitrap_results_4, aes(avg_cluster_prop))+
  geom_histogram(fill = "lightblue", color = "navy")+
  scale_fill_viridis(option = "viridis")+
  xlim(0, 1)+
  ylim(0, 4)+
  theme_classic()+
  xlab("Oviposition Trap Prevalence Estimates (by cluster and time point)")+
  ylab("Count")

```

### BG-Trap Results
```{r - bg descriptive}
## ensure data is in the right format and filter out <1 adult tested
bgtrap_results_2 <- bgtrap_results %>%
  mutate(year_week = as.factor(year_week), 
         month = factor(month, levels = c("march", "april", "may"), ordered = T),
         cluster = factor(cluster, levels = c("A", "B", "C", "D", "E", "F", "G", 
                                              "H", "I", "J", "K", "L"), 
                          ordered = T), 
         tot_adults = total_aegypti_caught + total_albopictus_caught, 
         tot_tested = screening_total_aeg,
         trap_prop = screening_wmel_aeg/screening_total_aeg, 
         screening_wt = screening_total_aeg-screening_wmel_aeg) %>%
  filter(tot_adults > 0)

## look at excluded data 
bgtrap_results_excluded <- bgtrap_results %>%
  mutate(year_week = as.factor(year_week), 
         month = factor(month, levels = c("march", "april", "may"), ordered = T),
         cluster = factor(cluster, levels = c("A", "B", "C", "D", "E", "F", "G", 
                                              "H", "I", "J", "K", "L"), 
                          ordered = T), 
         tot_adults = total_aegypti_caught + total_albopictus_caught, 
         tot_tested = screening_total_aeg,
         trap_prop = screening_wmel_aeg/screening_total_aeg, 
         screening_wt = screening_total_aeg-screening_wmel_aeg) %>%
 filter(tot_adults == 0) 

bgtrap_results_excluded %>%
  group_by(month) %>%
  summarize(n = n())


## total adults by time point
bgtrap_results_2 %>%
  #group_by(month) %>%
  summarize(total_adults = sum(tot_adults, na.rm = T), 
            total_alb = sum(total_albopictus_caught, na.rm  = T), 
            total_aeg = sum(total_aegypti_caught, na.rm = T),
            total_screen_aeg = sum(screening_total_aeg, na.rm = T), 
            total_wmel = sum(screening_wmel_aeg, na.rm = T))
 

## visualize Wolbachia prevalences
ggplot(bgtrap_results_2, aes(trap_prop))+
  geom_histogram(fill = "lightblue", color = "navy")+
  xlim(0, 1)+
  ylim(0, 20)+
  theme_classic()+
  xlab("BG-Sentinel Trap Proportion")+
  ylab("Count")

bgtrap_results_2 %>%
  group_by(cluster) %>%
  summarize(tot_aeg = sum(total_aegypti_caught, na.rm = T), 
            tot_alb = sum(total_albopictus_caught, na.rm = T), 
            tot_aeg_tested = sum(screening_total_aeg, na.rm = T), 
            tot_wmel = sum(screening_wmel_aeg, na.rm = T), 
            tot_caught = tot_aeg + tot_alb)

## proportions by cluster 
bgtrap_results_3 <- bgtrap_results_2 %>%
  group_by(cluster) %>%
  summarize(wmel_cluster_tot = sum(screening_wmel_aeg, na.rm = T), 
            wt_cluster_tot = sum(screening_wt, na.rm = T), 
            aeg_cluster_tot = sum(total_aegypti_caught, na.rm = T), 
            alb_cluster_tot = sum(total_albopictus_caught, na.rm = T), 
            cluster_tot_tested = sum(screening_total_aeg, na.rm = T), 
            avg_cluster_prop = mean(trap_prop, na.rm = T), 
            avg_cluster_sd = sd(trap_prop, na.rm = T))

### add confidence intervals
bgtrap_results_3$lower_CI <- NA
bgtrap_results_3$upper_CI <- NA

for(i in 1:nrow(bgtrap_results_3)){
  prop <- bgtrap_results_3$avg_cluster_prop[i]
  tot_tested <- bgtrap_results_3$cluster_tot_tested[i]
  
  conf <- prop.test(x = prop*tot_tested, n = tot_tested, conf.level = 0.95, correct = F)
  
  bgtrap_results_3$lower_CI[i] <- conf$conf.int[[1]]
  bgtrap_results_3$upper_CI[i] <- conf$conf.int[[2]]
}

bgtrap_results_3 <- as.data.frame(bgtrap_results_3) 

## proportions by cluster and time point
bgtrap_results_4 <- bgtrap_results_2 %>%
  group_by(cluster, month) %>%
  summarize(wmel_cluster_tot = sum(screening_wmel_aeg, na.rm = T), 
            wt_cluster_tot = sum(screening_wt, na.rm = T), 
            aeg_cluster_tot = sum(total_aegypti_caught, na.rm = T), 
            alb_cluster_tot = sum(total_albopictus_caught, na.rm = T), 
            cluster_tot_tested = sum(screening_total_aeg, na.rm = T), 
            avg_cluster_prop = mean(trap_prop, na.rm = T), 
            avg_cluster_sd = sd(trap_prop, na.rm = T))

### add confidence intervals
bgtrap_results_4$lower_CI <- NA
bgtrap_results_4$upper_CI <- NA

for(i in 1:nrow(bgtrap_results_4)){
  prop <- bgtrap_results_4$avg_cluster_prop[i]
  tot_tested <- bgtrap_results_4$cluster_tot_tested[i]
  
  conf <- prop.test(x = prop*tot_tested, n = tot_tested, conf.level = 0.95, correct = F)
  
  bgtrap_results_4$lower_CI[i] <- conf$conf.int[[1]]
  bgtrap_results_4$upper_CI[i] <- conf$conf.int[[2]]
}

bgtrap_results_4 <- as.data.frame(bgtrap_results_4) 

## visualize
ggplot(bgtrap_results_4, aes(month, avg_cluster_prop, group = cluster, 
                color = cluster))+
  geom_line()+
  geom_point()+
  geom_errorbar(aes(ymin = lower_CI, ymax = upper_CI, width = 0.2))+
  scale_color_viridis(discrete = T, option = "viridis")+
  theme_bw()+
  xlab("Time Point")+
  ylab("Proportion Aedes aegypti wMel Positive")+
  ylim(0, 1)+
  labs(title = "BG-Trap Prevalence")

## histogram
ggplot(bgtrap_results_4, aes(avg_cluster_prop))+
  geom_histogram(fill = "lightblue", color = "navy")+
  scale_fill_viridis(option = "viridis")+
  xlim(0, 1)+
  theme_classic()+
  xlab("Bg-Sentinel Prevalence Estimates (by cluster and time point)")+
  ylab("Count")

```

### Combine Ovitrap and BG-trap into One Dataframe
```{r}
## comparing avg_cluster_prop from both Ovitraps and BG Traps
trap_results <- left_join(bgtrap_results_4, ovitrap_results_4, by = c("cluster" = "cluster", "month" = "month"))

## final data frame
trap_results_final <- trap_results %>%
  rename(bg = avg_cluster_prop.x, 
         "bg_lower_CI" = "lower_CI.x", 
         "bg_upper_CI" = "upper_CI.x",
         "bg_tot_tested" = "cluster_tot_tested.x",
        # bg_adjusted = avg_adjusted_trap_prop, 
        # "bg_adj_lower_CI" = "lower_CI.y.x",
        # "bg_adj_upper_CI" = "upper_CI.y.x",
    ovitrap = avg_cluster_prop.y, 
         "ovitrap_lower_CI" = "lower_CI.y", 
         "ovitrap_upper_CI" = "upper_CI.y", 
         "ovitrap_tot_tested" = "cluster_tot_tested.y") %>%
        # ovitrap_adjusted = adj_cluster_prop, 
        # "adj_ovi_lower_CI" = "lower_CI.y.y", 
       #  "adj_ovi_upper_CI" = "upper_CI.y.y"
  dplyr::select(cluster, month, ovitrap, "ovitrap_lower_CI", "ovitrap_upper_CI", "ovitrap_tot_tested",
                bg, "bg_lower_CI", "bg_upper_CI", "bg_tot_tested") %>%
  arrange(month, cluster)

## final by cluster (not time points)
trap_results_final_cluster <- trap_results_final %>%
  group_by(cluster) %>%
  summarize(cluster_ovi = mean(ovitrap),
            cluster_bg = mean(bg))

```

### Plots of Wolbachia Prevalences
```{r}
## set colors
colors <- c("Ovitrap" = "blue", "BG-Trap" = "red")
mozzies <- c("Hatched Larvae" = viridis_pal[1], "Adults" = viridis_pal[4])

## March
trap_results_final %>%
  filter(month == "march") %>%
ggplot(aes(x = cluster))+
  geom_point(aes(y = ovitrap, color = "Ovitrap"), size = 3)+
  geom_errorbar(aes(ymin = ovitrap_lower_CI, ymax = ovitrap_upper_CI), color = "blue", lty = 3)+
  geom_point(aes(y = bg, color = "BG-Trap"), size = 3)+
  geom_errorbar(aes(ymin = bg_lower_CI, ymax = bg_upper_CI), lty = 2, color = "red")+
  theme_classic()+ 
  xlab("Cluster")+
  ylab("wMel Prevalence")+
  scale_color_manual(name = "Trap Type", values = colors)+
  theme(axis.text = element_text(size = 16), 
        axis.title = element_text(size = 18, face = "bold"))

## April
trap_results_final %>%
  filter(month == "april") %>%
ggplot(aes(x = cluster))+
  geom_point(aes(y = ovitrap, color = "Ovitrap"), size = 3)+
  geom_errorbar(aes(ymin = ovitrap_lower_CI, ymax = ovitrap_upper_CI), color = "blue", lty = 3)+
  geom_point(aes(y = bg, color = "BG-Trap"), size = 3)+
  geom_errorbar(aes(ymin = bg_lower_CI, ymax = bg_upper_CI), lty = 2, color = "red")+
  theme_classic()+ 
  xlab("Cluster")+
  ylab("wMel Prevalence")+
  scale_color_manual(name = "Trap Type", values = colors)+
  theme(axis.text = element_text(size = 16), 
        axis.title = element_text(size = 18, face = "bold"))

## May
trap_results_final %>%
  filter(month == "may") %>%
ggplot(aes(x = cluster))+
  geom_point(aes(y = ovitrap, color = "Ovitrap"), size = 3)+
  geom_errorbar(aes(ymin = ovitrap_lower_CI, ymax = ovitrap_upper_CI), color = "blue", lty = 3)+
  geom_point(aes(y = bg, color = "BG-Trap"), size = 3)+
  geom_errorbar(aes(ymin = bg_lower_CI, ymax = bg_upper_CI), lty = 2, color = "red")+
  theme_classic()+ 
  xlab("Cluster")+
  ylab("wMel Prevalence")+
  scale_color_manual(name = "Trap Type", values = colors)+
  theme(axis.text = element_text(size = 16), 
        axis.title = element_text(size = 18, face = "bold"))

```

## Correlation between Trap Types 
### Correlation Plots 
```{r}
## By Month
trap_results_final_2 <- trap_results_final %>%
  mutate(month = str_to_title(month), 
         month = factor(month, levels = c("March", "April", "May")))

viridis_pal <- c(viridis::viridis(n = 3))
months <- c("March" = viridis_pal[1], "April" = viridis_pal[2], "May" = viridis_pal[3])

ggplot(trap_results_final_2, aes(bg, ovitrap))+
  geom_point(size = 3, aes(color = month))+
  geom_errorbar(aes(ymin = ovitrap_lower_CI, ymax = ovitrap_upper_CI), alpha = 0.15, show.legend = F)+
  geom_errorbar(aes(xmin = bg_lower_CI, xmax = bg_upper_CI), alpha = 0.15, show.legend = F)+
  geom_smooth(aes(bg, ovitrap), method = "lm", se = F, color = "black", )+
  geom_vline(xintercept = 0.6, color = "blue", lty = 2)+
  geom_hline(yintercept = 0.6, color = "blue", lty = 2)+
  theme_classic()+
  xlab("Adult wMel Prevalence (BG-trap based)")+
  ylab("Hatched Larvae wMel Prevalence (Ovitrap based)")+
  theme(axis.text = element_text(size = 16), 
        axis.title = element_text(size = 16, face = "bold"))+
  scale_color_manual(name = "Month", values = months)+
  theme(aspect.ratio = 1)

## calculate r^2
lm_model <- lm(ovitrap~bg, data = trap_results_final_2) 

```

### Statistical Tests Comparing Traps
```{r}
## Group data sets by cluster 
trap_results_final_3 <- trap_results_final %>%
  group_by(cluster)

trap_results_final_cluster_2 <- trap_results_final_cluster %>%
  group_by(cluster)

## T-Test
###by cluster 
wilcox.test(trap_results_final_cluster_2$cluster_ovi, trap_results_final_cluster_2$cluster_bg, paired = TRUE)

### by cluster and time point
trap_results_final_3_wx <- trap_results_final_3 %>%
  filter(!(is.na(ovitrap))) %>%
  filter(!(ovitrap == 0)) 

wilcox.test(trap_results_final_3_wx$ovitrap, trap_results_final_3_wx$bg, paired = T) 

## Correlation
### check linearity
### by cluster  
ggplot(trap_results_final_cluster_2)+
  geom_point(aes(cluster_ovi, cluster_bg))+
  geom_line(aes(cluster_ovi, cluster_ovi), color = "red")+
  theme_bw()+
  xlab("Ovitrap Prevalence")+
  ylab("BG-Trap Prevalence")+
  labs(title = "Ovitrap vs. BG-Trap By Cluster")

#### by cluster and time point
ggplot(trap_results_final_3)+
  geom_point(aes(ovitrap, bg))+
  geom_line(aes(ovitrap, ovitrap), color = "red")+
  theme_bw()+
  xlab("Ovitrap Prevalence")+
  ylab("BG-Trap Prevalence")+
  labs(title = "Ovitrap vs. BG-Trap By Cluster and Time Point") 

## check heteroskedasticity
lm1 <- lm(cluster_bg ~ cluster_ovi, data = trap_results_final_cluster_2)
lm2 <- lm(bg ~ ovitrap, data = trap_results_final_3)

### look at plots 
par(mfrow=c(2,2))
plot(lm1)
par(mfrow=c(2,2))
plot(lm2)

## Spearman-rank Correlation Test
### across clusters 
cor.test(~cluster_ovi+cluster_bg, data = trap_results_final_cluster_2, method = "spearman")

### across clusters and time points
cor.test(~ovitrap+bg, data = trap_results_final_3, method = "spearman") 

```

## Predictive Regression Models 
### Set Up Data Frames for Models 
```{r - stats df's}
## cluster level data frame
d1 <- ovitrap_results_4 %>%
  rename(n_aeg_ovi = aeg_cluster_tot, 
         n_alb_ovi = alb_cluster_tot, 
         n_tested_ovi = cluster_tot_tested, 
         n_wmel_ovi = wmel_cluster_tot, 
         n_wt_ovi = wt_cluster_tot, 
         ovitrap = avg_cluster_prop, 
         ovitrap_lower_CI = lower_CI, 
         ovitrap_upper_CI = upper_CI) %>%
  mutate(n_total_ovi = n_aeg_ovi + n_alb_ovi) %>%
  dplyr::select(cluster, month, n_aeg_ovi, n_alb_ovi, n_tested_ovi, n_wmel_ovi, 
                n_wt_ovi, n_total_ovi, ovitrap, ovitrap_lower_CI, ovitrap_upper_CI)
  
d2 <- bgtrap_results_4 %>%
  rename(n_aeg_bg = aeg_cluster_tot, 
         n_alb_bg = alb_cluster_tot, 
         n_tested_bg = cluster_tot_tested, 
         n_wmel_bg = wmel_cluster_tot, 
         n_wt_bg = wt_cluster_tot, 
         bg = avg_cluster_prop, 
         bg_lower_CI = lower_CI, 
         bg_upper_CI = upper_CI) %>%
  mutate(n_total_bg = n_aeg_bg + n_alb_bg) %>%
  dplyr::select(cluster, month, n_aeg_bg, n_alb_bg, n_tested_bg, n_wmel_bg, 
                n_wt_bg, n_total_bg, bg, bg_lower_CI, bg_upper_CI)

mod2_df <- left_join(d2, d1, by = c("cluster" = "cluster", "month" = "month"))

model2_df <- mod2_df %>%
  ungroup() %>%
  mutate(total_caught = n_total_bg) %>%
  group_by(cluster) %>%
  arrange(month) %>%
  mutate(lag_1_ovi_count = lag(n_wmel_ovi, 1),
         lag_2_ovi_count = lag(n_wmel_ovi, 2),
         lag_3_ovi_count = lag(n_wmel_ovi, 3),
         lag_1_ovi_prop = lag(ovitrap, 1),
         lag_2_ovi_prop = lag(ovitrap, 2)) %>%
  ungroup()

model3_df <- model2_df %>%
  group_by(cluster) %>%
  arrange(cluster, month) %>%
  mutate(ovi_count_lag_1 = lag(n_wmel_ovi, 1),
         ovi_count_lag_2 = lag(n_wmel_ovi, 2),
         bg_count_lag_1 = lag(n_wmel_bg, 1),
         bg_count_lag_2 = lag(n_wmel_bg, 2),
         bg_prop_lag_1 = lag(bg, 1),
         bg_prop_lag_2 = lag(bg, 2)) %>%
  arrange(cluster, desc(month)) %>%
         mutate(lag_plus_1_bg_counts = lag(n_wmel_bg, 1)) %>%
  arrange(cluster, month) %>%
  ungroup()

```

### Check Autocorrelation
```{r - check autocorrelation}

clusters <- unique(model3_df$cluster)
model4_df <- model3_df %>%
  dplyr::select(cluster) %>%
  distinct(cluster)
model4_df$bg_ovi_cor <- NA 
model4_df$bg_ovi_cor_p <- NA 
model4_df$bg_lag_1_ovi_cor <- NA 
model4_df$bg_lag_1_ovi_cor_p <- NA
model4_df$lag_plus_1_bg_ovi_cor <- NA 
model4_df$lag_plus_1_bg_ovi_cor_p <- NA

for (i in seq_along(clusters)) {
  ## Set cluster
  cl <- clusters[i]
  
  ## Extract counts safely
  cluster_data <- model3_df %>%
    filter(cluster == cl) %>%
    dplyr::select(n_wmel_bg, n_wmel_ovi, lag_1_ovi_count, lag_2_ovi_count, lag_plus_1_bg_counts)
  
  ## Ensure at least 2 non-NA observations for correlation
  if (nrow(cluster_data) < 2 || sum(complete.cases(cluster_data)) < 2) {
    model4_df$bg_ovi_cor[i] <- NA
    model4_df$bg_ovi_cor_p[i] <- NA
    model4_df$bg_lag_1_ovi_cor[i] <- NA
    model4_df$bg_lag_1_ovi_cor_p[i] <- NA
    model4_df$lag_plus_1_bg_ovi_cor[i] <- NA
    model4_df$lag_plus_1_bg_ovi_cor_p[i] <- NA
    next  # Skip to the next iteration
  }
  
  ## Create data frame for correlation
  df <- cluster_data
  
  ## Spearman correlation tests with NA handling
  tryCatch({
    bg_ovi_cor <- cor.test(df$n_wmel_bg, df$n_wmel_ovi, method = "spearman")
    model4_df$bg_ovi_cor[i] <- bg_ovi_cor$estimate
    model4_df$bg_ovi_cor_p[i] <- bg_ovi_cor$p.value
  }, error = function(e) {
    model4_df$bg_ovi_cor[i] <- NA
    model4_df$bg_ovi_cor_p[i] <- NA
  })
  
  tryCatch({
    bg_lag_1_ovi_cor <- cor.test(df$n_wmel_bg, df$lag_1_ovi_count, method = "spearman")
    model4_df$bg_lag_1_ovi_cor[i] <- bg_lag_1_ovi_cor$estimate
    model4_df$bg_lag_1_ovi_cor_p[i] <- bg_lag_1_ovi_cor$p.value
  }, error = function(e) {
    model4_df$bg_lag_1_ovi_cor[i] <- NA
    model4_df$bg_lag_1_ovi_cor_p[i] <- NA
  })
  
  tryCatch({
    lag_plus_1_bg_ovi_cor <- cor.test(df$lag_plus_1_bg_counts, df$n_wmel_ovi, method = "spearman")
    model4_df$lag_plus_1_bg_ovi_cor[i] <- lag_plus_1_bg_ovi_cor$estimate
    model4_df$lag_plus_1_bg_ovi_cor_p[i] <- lag_plus_1_bg_ovi_cor$p.value
  }, error = function(e) {
    model4_df$lag_plus_1_bg_ovi_cor[i] <- NA
    model4_df$lag_plus_1_bg_ovi_cor_p[i] <- NA
  })
}

```

### Models 
```{r}
## run models 
mod1 <- glmer.nb(n_wmel_bg ~ lag_1_ovi_count + (1|cluster) + 
                  offset(log(total_caught)),  
                  na.action=na.exclude, data = model2_df)
mod2 <- glmer.nb(n_wmel_bg ~ lag_1_ovi_count + ovitrap + (1|cluster) + 
                  offset(log(total_caught)),  
                  na.action=na.exclude, data = model2_df)
mod3 <- glmer.nb(n_wmel_bg ~ lag_1_ovi_count + lag_1_ovi_prop +
                (1|cluster) + offset(log(total_caught)),  
                  na.action=na.exclude, data = model2_df)
mod4 <- glmer.nb(n_wmel_bg ~ lag_1_ovi_count + month +
                (1|cluster) + offset(log(total_caught)),  
                  na.action=na.exclude, data = model2_df)
mod5 <- glmer.nb(n_wmel_bg ~ lag_1_ovi_count + lag_1_ovi_prop + ovitrap +
                (1|cluster) + offset(log(total_caught)),  
                  na.action=na.exclude, data = model2_df)
mod6 <- glmer.nb(n_wmel_bg ~ lag_1_ovi_count + lag_1_ovi_prop +
                  month + (1|cluster) + offset(log(total_caught)),  
                  na.action=na.exclude, data = model2_df) 
mod7 <- glmer.nb(n_wmel_bg ~ lag_1_ovi_count + lag_1_ovi_prop + ovitrap + month +
                (1|cluster) + offset(log(total_caught)),  
                  na.action=na.exclude, data = model2_df)
mod8 <- glmer.nb(n_wmel_bg ~ lag_1_ovi_count + ovitrap*month + (1|cluster) + 
                  offset(log(total_caught)),  
                  na.action=na.exclude, data = model2_df)
mod9 <- glmer.nb(n_wmel_bg ~ lag_1_ovi_count + lag_1_ovi_prop + ovitrap*month + 
                  (1|cluster) + offset(log(total_caught)),  
                  na.action=na.exclude, data = model2_df) 

## get Mean Absolute Errors (MAEs)
models1 <- c('1', '2', '3', '4', '5', '6', '7', '8', '9')
models <- list(mod1, mod2, mod3, mod4, mod5, mod6, mod7, mod8, mod9)

real_bg_counts <- model2_df$n_wmel_bg

## create data frame to add to  
  mod_df <- as.data.frame(matrix(ncol = 2, nrow = 9))
  colnames(mod_df) <- c('model', 'MAE')
  mod_df$model <- models1
  mod_df$MAE <- NA
  
for(i in 1:length(models)){
  
  # calculate response variables 
  mod <- models[[i]]
  response <- predict(mod, type = "response")
  
  # create table to calc
  df <- as.data.frame(matrix(ncol = 2, nrow = 36))
  colnames(df) <- c('real_counts', 'model_counts')
  df$real_counts <- real_bg_counts
  df$model_counts <- response
  
  summ <- df %>%
    mutate(diff = real_counts - model_counts) %>%
    summarize(mae = mean(diff, na.rm = T))
  
  # add to MAE table
  mod_df$MAE[i] <- summ$mae
}

## calculate BIC  
BIC(mod1, mod2, mod3, mod4, mod5, mod6, mod7, mod8, mod9) 
```

### Model Plots
```{r}
## set up data frame with model predictions and CI's
## Model 5 
pred_mod_df <- model2_df

### define a function to get the fitted values
fitted_fun <- function(model) {
  predict(model, type = "response")
}
### use bootMer to get bootstrapped CIs
set.seed(123)  # For reproducibility
boot_results <- bootMer(mod5, FUN = fitted_fun, nsim = 1000, use.u = TRUE)

### Calculate the bootstrapped confidence intervals
boot_ci <- apply(boot_results$t, 2, function(x) quantile(x, c(0.025, 0.975), na.rm = T))

### Combine the results into a data frame
fitted_values <- predict(mod5, type = "response")
ci_df_mod5 <- data.frame(fitted_values = fitted_values,
                    lower_ci = boot_ci[1, ],
                    upper_ci = boot_ci[2, ])
# attach to df
pred_mod_df$mod5_count <- ci_df_mod5$fitted_values
pred_mod_df$mod5_lw_ci <- ci_df_mod5$lower_ci
pred_mod_df$mod5_up_ci <- ci_df_mod5$upper_ci

## Model 2
mod_pred_2 <- predict(mod2, type = "link", se.fit = T)

### use bootMer to get bootstrapped CIs
set.seed(123)  # For reproducibility
boot_results <- bootMer(mod2, FUN = fitted_fun, nsim = 1000, use.u = TRUE)

### Calculate the bootstrapped confidence intervals
boot_ci <- apply(boot_results$t, 2, function(x) quantile(x, c(0.025, 0.975), na.rm = T))

### Combine the results into a data frame
fitted_values <- predict(mod2, type = "response")
ci_df_mod2 <- data.frame(fitted_values = fitted_values,
                    lower_ci = boot_ci[1, ],
                    upper_ci = boot_ci[2, ])

### attach to df
pred_mod_df$mod2_count <- ci_df_mod2$fitted_values
pred_mod_df$mod2_lw_ci <- ci_df_mod2$lower_ci
pred_mod_df$mod2_up_ci <- ci_df_mod2$upper_ci


## calculate the model error
pred_mod_df_2 <- pred_mod_df %>%
  mutate(diff_5 = (mod5_count - n_wmel_bg), 
         error_5 = diff_5/n_wmel_bg,
         diff_2 = (mod2_count - n_wmel_bg), 
         error_2 = diff_2/n_wmel_bg)

## look at error by cluster and month
pred_mod_df_2 %>%
  group_by(cluster, month) %>%
  filter(error_5 != Inf | error_2 != Inf) %>%
  summarize(overall_5 = mean(error_5, na.rm = T), 
            overall_2 = mean(error_2, na.rm = T))

## look at error by onth
pred_mod_df_2 %>%
  ungroup() %>%
  group_by(month) %>%
  filter(error_5 != Inf | error_2 != Inf) %>%
  summarize(overall_5 = mean(error_5, na.rm = T), 
            overall_2 = mean(error_2, na.rm = T))

## plot point estimates
colors <- c("Model 5" = "blue", "Model 2" = "lightblue", "BG-Trap" = "red")

### march
pred_mod_df_2 %>%
  filter(month == "march") %>%
ggplot(aes(x = cluster))+
  geom_point(aes(y = n_wmel_bg, color = "BG-Trap"), size = 3)+
  geom_point(aes(y = mod5_count, color = "Model 5"), size = 3)+
  geom_point(aes(y = mod2_count, color = "Model 2"), size = 3)+
  theme_classic()+ 
  xlab("Cluster")+
  ylab("wMel Count")+
  scale_color_manual(name = "Trap Type", values = colors)+
  theme(axis.text = element_text(size = 16), 
        axis.title = element_text(size = 18, face = "bold"))

### april 
pred_mod_df_2 %>%
  filter(month == "april") %>%
ggplot(aes(x = cluster))+
  geom_point(aes(y = n_wmel_bg, color = "BG-Trap"), size = 3)+
  geom_point(aes(y = mod5_count, color = "Model 5"), size = 3)+
  geom_errorbar(aes(ymin = mod5_lw_ci, ymax = mod5_up_ci), color = "blue", lty = 3)+
  geom_point(aes(y = mod2_count, color = "Model 2"), size = 3)+
  geom_errorbar(aes(ymin = mod2_lw_ci, ymax = mod2_up_ci), color = "lightblue", lty = 3)+
  theme_classic()+ 
  xlab("Cluster")+
  ylab("wMel Count")+
  scale_color_manual(name = "Trap Type", values = colors)+
  theme(axis.text = element_text(size = 16), 
        axis.title = element_text(size = 18, face = "bold"))

### may
pred_mod_df_2 %>%
  filter(month == "may") %>%
ggplot(aes(x = cluster))+
  geom_point(aes(y = n_wmel_bg, color = "BG-Trap"), size = 3)+
  geom_point(aes(y = mod5_count, color = "Model 5"), size = 3)+
  geom_errorbar(aes(ymin = mod5_lw_ci, ymax = mod5_up_ci), color = "blue", lty = 3)+
  geom_point(aes(y = mod2_count, color = "Model 2"), size = 3)+
  geom_errorbar(aes(ymin = mod2_lw_ci, ymax = mod2_up_ci), color = "lightblue", lty = 3)+
  theme_classic()+ 
  xlab("Cluster")+
  ylab("wMel Count")+
  scale_color_manual(name = "Trap Type", values = colors)+
  theme(axis.text = element_text(size = 16), 
        axis.title = element_text(size = 18, face = "bold"))


## plot prevalence estimates
pred_mod_df_3 <- pred_mod_df_2 %>%
  mutate(mod5_prev = mod5_count/n_tested_bg, 
         mod5_prev_adj = if_else(mod5_prev > 1, 1, mod5_prev),
         mod2_prev = mod2_count/n_tested_bg, 
         mod2_prev_adj = if_else(mod2_prev > 1, 1, mod2_prev))

### add binomial confidence intervals
pred_mod_df_3$mod5_prev_lw_CI <- NA
pred_mod_df_3$mod5_prev_up_CI <- NA
pred_mod_df_3$mod2_prev_lw_CI <- NA
pred_mod_df_3$mod2_prev_up_CI <- NA

for(i in 1:nrow(pred_mod_df_3)){
  # model 5
  prop_5 <- pred_mod_df_3$mod5_prev[i]
  
  if(is.na(prop_5) | prop_5 > 1){
    pred_mod_df_3$mod5_prev_lw_CI[i] <- NA
    pred_mod_df_3$mod5_prev_up_CI[i] <- NA
  } else{
      tot_tested_5 <- pred_mod_df_3$n_tested_bg[i]
  
  conf_5 <- prop.test(x = prop_5*tot_tested_5, n = tot_tested_5, conf.level = 0.95, correct = F)
  
  pred_mod_df_3$mod5_prev_lw_CI[i] <- conf_5$conf.int[[1]]
  pred_mod_df_3$mod5_prev_up_CI[i] <- conf_5$conf.int[[2]]
  }
  
  # model 2
  prop_2 <- pred_mod_df_3$mod2_prev[i]
  
  if(is.na(prop_2) | prop_2 > 1){
    pred_mod_df_3$mod2_prev_lw_CI[i] <- NA
    pred_mod_df_3$mod2_prev_up_CI[i] <- NA
  } else{
      tot_tested_2 <- pred_mod_df_3$n_tested_bg[i]

  conf_2 <- prop.test(x = prop_2*tot_tested_2, n = tot_tested_2, conf.level = 0.95, correct = F)
  
  pred_mod_df_3$mod2_prev_lw_CI[i] <- conf_2$conf.int[[1]]
  pred_mod_df_3$mod2_prev_up_CI[i] <- conf_2$conf.int[[2]]
  }
}

pred_mod_df_3 <- as.data.frame(pred_mod_df_3)

### march
pred_mod_df_3 %>%
  filter(month == "march") %>%
ggplot(aes(x = cluster))+
  geom_point(aes(y = bg, color = "BG-Trap"), size = 3)+
  geom_errorbar(aes(ymin = bg_lower_CI, ymax = bg_upper_CI), color = "red", lty = 3)+
  geom_point(aes(y = mod5_count/n_tested_bg, color = "Model 5"), size = 3)+
  theme_classic()+ 
  xlab("Cluster")+
  ylab("wMel Prevalence")+
  scale_color_manual(name = "Trap Type", values = colors)+
  theme(axis.text = element_text(size = 16), 
        axis.title = element_text(size = 18, face = "bold"))

### april
pred_mod_df_3 %>%
  filter(month == "april") %>%
ggplot(aes(x = cluster))+
  geom_point(aes(y = bg, color = "BG-Trap"), size = 3)+
  geom_errorbar(aes(ymin = bg_lower_CI, ymax = bg_upper_CI), color = "red", lty = 3)+
  geom_point(aes(y = mod5_prev, color = "Model 5"), size = 3)+
  geom_errorbar(aes(ymin = mod5_prev_lw_CI, ymax = mod5_prev_up_CI), 
                color = "blue", lty = 3)+
  geom_point(aes(y = mod2_prev, color = "Model 2"), size = 3)+
  geom_errorbar(aes(ymin = mod2_prev_lw_CI, ymax = mod2_prev_up_CI), 
                color = "lightblue", lty = 3)+
  theme_classic()+ 
  xlab("Cluster")+
  ylab("wMel Prevalence")+
  scale_color_manual(name = "Trap Type", values = colors)+
  theme(axis.text = element_text(size = 16), 
        axis.title = element_text(size = 18, face = "bold"))

### may
pred_mod_df_3 %>%
  filter(month == "may") %>%
ggplot(aes(x = cluster))+
  geom_point(aes(y = bg, color = "BG-Trap"), size = 3)+
  geom_errorbar(aes(ymin = bg_lower_CI, ymax = bg_upper_CI), color = "red", lty = 3)+
  geom_point(aes(y = mod5_prev, color = "Model 5"), size = 3)+
  geom_errorbar(aes(ymin = mod5_prev_lw_CI, ymax = mod5_prev_up_CI), 
                color = "blue", lty = 3)+
  geom_point(aes(y = mod2_prev, color = "Model 2"), size = 3)+
  geom_errorbar(aes(ymin = mod2_prev_lw_CI, ymax = mod2_prev_up_CI), 
                color = "lightblue", lty = 3)+
  theme_classic()+ 
  xlab("Cluster")+
  ylab("wMel Prevalence")+
  scale_color_manual(name = "Trap Type", values = colors)+
  theme(axis.text = element_text(size = 16), 
        axis.title = element_text(size = 18, face = "bold"))

## Check correlation
### Model 5 counts
ggplot(pred_mod_df_3, aes(n_wmel_bg, mod5_count))+
  geom_point(size = 3)+
  geom_errorbar(aes(xmin = bg_lower_CI, xmax = bg_upper_CI), alpha = 0.15, show.legend = F)+
  geom_smooth(aes(n_wmel_bg, mod5_count), method = "lm", color = "red")+
  theme_classic()+
  xlab("BG-Trap wMel Count")+
  ylab("Model 5 Predicted Count")+
  theme(axis.text = element_text(size = 16), 
        axis.title = element_text(size = 18, face = "bold"))+
  theme(aspect.ratio = 1) 

### calculate R^2
lm_mod_5 <- lm(mod5_count ~ n_wmel_bg, data = pred_mod_df_3) 

### Model 2 counts
ggplot(pred_mod_df_3, aes(n_wmel_bg, mod2_count))+
  geom_point(size = 3)+
  geom_errorbar(aes(xmin = bg_lower_CI, xmax = bg_upper_CI), alpha = 0.15, show.legend = F)+
  geom_smooth(aes(n_wmel_bg, mod2_count), method = "lm", color = "red")+
  theme_classic()+
  xlab("BG-Trap wMel Count")+
  ylab("Model 2 Predicted Count")+
  theme(axis.text = element_text(size = 16), 
        axis.title = element_text(size = 18, face = "bold"))+
  theme(aspect.ratio = 1) 

### calculate R^2
lm_mod_2 <- lm(mod2_count ~ n_wmel_bg, data = pred_mod_df_3) 

### model 5 prevalence
ggplot(pred_mod_df_3, aes(bg, mod5_prev))+
  geom_point(size = 3)+
  geom_smooth(aes(bg, mod5_prev), method = "lm", color = "red")+
  geom_vline(xintercept = 0.6, color = "blue", lty = 2)+
  geom_hline(yintercept = 0.6, color = "blue", lty = 2)+
  theme_classic()+
  xlab("BG-Trap Prevalence")+
  ylab("Model 5 Predicted Prevalence")+
  xlim(0, 1)+
  ylim(0, 1.3)+
  theme(axis.text = element_text(size = 16), 
        axis.title = element_text(size = 18, face = "bold"))+
  theme(aspect.ratio = 1)

### calculate R^2
lm_mod_5b <- lm(mod5_prev ~ bg, data = pred_mod_df_3) 

### model 2 prevalence
ggplot(pred_mod_df_3, aes(bg, mod2_prev))+
  geom_point(size = 3)+
  geom_smooth(aes(bg, mod2_prev), method = "lm", color = "red")+
  geom_vline(xintercept = 0.6, color = "blue", lty = 2)+
  geom_hline(yintercept = 0.6, color = "blue", lty = 2)+
  theme_classic()+
  xlab("BG-Trap Prevalence")+
  ylab("Model 2 Predicted Prevalence")+
  xlim(0, 1)+
  ylim(0, 1.3)+
  theme(axis.text = element_text(size = 16), 
        axis.title = element_text(size = 18, face = "bold"))+
  theme(aspect.ratio = 1)

### calculate R^2
lm_mod_2b <- lm(mod2_prev ~ bg, data = pred_mod_df_3) 

## Spearman correlation
### model 5
cor.test(~mod5_prev+bg, data = pred_mod_df_3, method = "spearman", exact = F) 
cor.test(~mod5_count+n_wmel_bg, data = pred_mod_df_3, method = "spearman", exact = F) 

### model 2
cor.test(~mod2_prev+bg, data = pred_mod_df_3, method = "spearman", exact = F) 
cor.test(~mod2_count+n_wmel_bg, data = pred_mod_df_3, method = "spearman", exact = F) 

```

## Sensitivity Anlaysis - autocorrelation within and between traps
```{r - trap autocorrelation}
clusters <- unique(model3_df$cluster)
model4_df <- model3_df %>%
  dplyr::select(cluster) %>%
  distinct(cluster)
model4_df$bg_bg_cor <- NA 
model4_df$bg_bg_cor_p <- NA 
model4_df$bg_lag_1_bg_cor <- NA 
model4_df$bg_lag_1_bg_cor_p <- NA
model4_df$ovi_ovi_cor <- NA 
model4_df$ovi_ovi_cor_p <- NA 
model4_df$ovi_lag_1_ovi_cor <- NA 
model4_df$ovi_lag_1_ovi_cor_p <- NA 
model4_df$bg_lag_plus_1_bg_cor <- NA 
model4_df$bg_lag_1_plus_bg_cor_p <- NA

for (i in seq_along(clusters)) {
  ## Set cluster
  cl <- clusters[i]
  
  ## Extract counts safely
  cluster_data <- model3_df %>%
    filter(cluster == cl) %>%
    dplyr::select(n_wmel_bg, bg_count_lag_1, n_wmel_ovi, lag_1_ovi_count, lag_2_ovi_count, lag_plus_1_bg_counts)
  
  ## Ensure at least 2 non-NA observations for correlation
  if (nrow(cluster_data) < 2 || sum(complete.cases(cluster_data)) < 2) {
    model4_df$bg_bg_cor[i] <- NA
    model4_df$bg_bg_cor_p[i] <- NA
    model4_df$bg_lag_1_bg_cor[i] <- NA
    model4_df$bg_lag_1_bg_cor_p[i] <- NA
    model4_df$ovi_ovi_cor[i] <- NA
    model4_df$ovi_ovi_cor_p[i] <- NA
    model4_df$ovi_lag_1_ovi_cor[i] <- NA
    model4_df$ovi_lag_1_ovi_cor_p[i] <- NA
    model4_df$bg_lag_plus_1_bg_cor[i] <- NA
    model4_df$bg_lag_1_plus_bg_cor_p[i] <- NA
    next  # Skip to the next iteration
  }
  
  ## Create data frame for correlation
  df <- cluster_data
  df$bg_counts_1 <- df$n_wmel_bg
  df$ovi_counts_1 <- df$n_wmel_ovi

  ## Spearman correlation tests with error handling
  tryCatch({
    bg_bg_cor <- cor.test(df$n_wmel_bg, df$bg_counts_1, method = "spearman")
    model4_df$bg_bg_cor[i] <- bg_bg_cor$estimate
    model4_df$bg_bg_cor_p[i] <- bg_bg_cor$p.value
  }, error = function(e) {
    model4_df$bg_bg_cor[i] <- NA
    model4_df$bg_bg_cor_p[i] <- NA
  })

  tryCatch({
    bg_lag_1_bg_cor <- cor.test(df$n_wmel_bg, df$bg_count_lag_1, method = "spearman")
    model4_df$bg_lag_1_bg_cor[i] <- bg_lag_1_bg_cor$estimate
    model4_df$bg_lag_1_bg_cor_p[i] <- bg_lag_1_bg_cor$p.value
  }, error = function(e) {
    model4_df$bg_lag_1_bg_cor[i] <- NA
    model4_df$bg_lag_1_bg_cor_p[i] <- NA
  })
  
  tryCatch({
    ovi_ovi_cor <- cor.test(df$n_wmel_ovi, df$ovi_counts_1, method = "spearman")
    model4_df$ovi_ovi_cor[i] <- ovi_ovi_cor$estimate
    model4_df$ovi_ovi_cor_p[i] <- ovi_ovi_cor$p.value
  }, error = function(e) {
    model4_df$ovi_ovi_cor[i] <- NA
    model4_df$ovi_ovi_cor_p[i] <- NA
  })
  
  tryCatch({
    ovi_lag_1_ovi_cor <- cor.test(df$n_wmel_ovi, df$lag_1_ovi_count, method = "spearman")
    model4_df$ovi_lag_1_ovi_cor[i] <- ovi_lag_1_ovi_cor$estimate
    model4_df$ovi_lag_1_ovi_cor_p[i] <- ovi_lag_1_ovi_cor$p.value
  }, error = function(e) {
    model4_df$ovi_lag_1_ovi_cor[i] <- NA
    model4_df$ovi_lag_1_ovi_cor_p[i] <- NA
  })
  
  tryCatch({
    bg_lag_1_plus_bg_cor <- cor.test(df$n_wmel_bg, df$lag_plus_1_bg_counts, method = "spearman")
    model4_df$bg_lag_plus_1_bg_cor[i] <- bg_lag_1_plus_bg_cor$estimate
    model4_df$bg_lag_1_plus_bg_cor_p[i] <- bg_lag_1_plus_bg_cor$p.value
  }, error = function(e) {
    model4_df$bg_lag_plus_1_bg_cor[i] <- NA
    model4_df$bg_lag_1_plus_bg_cor_p[i] <- NA
  })
}

```

## Sensitivity Anlaysis - within cluster variation 
```{r - within cluster variation}
colors <- c("Ovitrap" = "blue", "BG-Trap" = "red")

# box plot or violin plot with month on x axis, box for each trap type, and then variation within cluster as the y
# each data point is a cluster-level variation by month
## Ovitrap
ovitrap_results_boxplot <- ovitrap_results_2 %>%
  group_by(cluster, month) %>%
  mutate(ovi_n_obs = n()) %>%
  summarize(Ovitrap = var(trap_prop, na.rm = T), 
            ovi_n_obs) %>%
  mutate(month = factor(month, levels = c("March", "April", "May"), ordered = T)) %>%
  distinct(cluster, month, .keep_all = T)

### add confidence intervals
ovitrap_results_boxplot$lower_ovi_CI <- NA
ovitrap_results_boxplot$upper_ovi_CI <- NA

for(i in 1:nrow(ovitrap_results_boxplot)){
  var <- ovitrap_results_boxplot$Ovitrap[i]
  tot_tested <- ovitrap_results_boxplot$ovi_n_obs[i]
  n <- tot_tested - 1
  
  ovitrap_results_boxplot$lower_ovi_CI[i] <- (n*var)/qchisq(0.975, df = n)
  ovitrap_results_boxplot$upper_ovi_CI[i] <- (n*var)/qchisq(0.025, df = n)
}

ovitrap_results_boxplot <- as.data.frame(ovitrap_results_boxplot)

## BG-trap
bg_results_boxplot <- bgtrap_results_2 %>%
  group_by(cluster, month) %>%
  mutate(bg_n_obs = n()) %>%
  summarize("BG-Trap" = var(trap_prop, na.rm = T), 
            bg_n_obs) %>%
  mutate(month = str_to_title(month),
         month = factor(month, levels = c("March", "April", "May"), ordered = T)) %>%
  distinct(cluster, month, .keep_all = T)

### add confidence intervals
bg_results_boxplot$lower_bg_CI <- NA
bg_results_boxplot$upper_bg_CI <- NA

for(i in 1:nrow(bg_results_boxplot)){
  var <- bg_results_boxplot$"BG-Trap"[i]
  tot_tested <- bg_results_boxplot$bg_n_obs[i]
  n <- tot_tested - 1
  
  bg_results_boxplot$lower_bg_CI[i] <- (n*var)/qchisq(0.975, df = n)
  bg_results_boxplot$upper_bg_CI[i] <- (n*var)/qchisq(0.025, df = n)
}

bg_results_boxplot <- as.data.frame(bg_results_boxplot)

## Combine datasets 
boxplot_df <- left_join(ovitrap_results_boxplot, bg_results_boxplot, 
                        by = c("cluster" = "cluster", "month" = "month"))
boxplot_df <- boxplot_df %>%
  dplyr::select(cluster, month, Ovitrap, lower_ovi_CI, upper_ovi_CI, 
                "BG-Trap", lower_bg_CI, upper_bg_CI)

## Pivot longer
boxplot_df_long <- boxplot_df %>%
  pivot_longer(cols = c("Ovitrap", "BG-Trap"), 
               values_to = "range", 
               names_to = "trap_type") %>%
  ungroup() %>%
  group_by(month)


## Plots
ggplot(boxplot_df_long, aes(x = month, y = range, fill = trap_type))+
  geom_boxplot()+
  scale_fill_manual(values = c("red", "blue"), 
                    name = "Trap Type")+
  ylab("Within Cluster Variance")+
  xlab("Month")+
  theme_classic()+
  theme(axis.text = element_text(size = 16), 
        axis.title = element_text(size = 18, face = "bold"))


ggplot(boxplot_df_long, aes(x = month, y = range, fill = trap_type))+
  geom_violin()+
  scale_fill_manual(values = c("red", "blue"), 
                    name = "Trap Type")+
  ylab("Within Cluster Variance")+
  xlab("Month")+
  theme_classic()+
  theme(axis.text = element_text(size = 16), 
        axis.title = element_text(size = 18, face = "bold"))

## Summarize
boxplot_df %>%
  group_by(month) %>%
  summarize(ovitrap = mean(Ovitrap, na.rm = T), 
            BG = mean(`BG-Trap`, na.rm = T))

# Forest Plots
### get number of observations
n_obs <- left_join(ovitrap_results_boxplot, bg_results_boxplot, 
                        by = c("cluster" = "cluster", "month" = "month")) %>%
  dplyr::select(cluster, month, ovi_n_obs, bg_n_obs)

n_obs <- n_obs %>%
  rename(Ovitrap = ovi_n_obs, 
         "BG-Trap" = bg_n_obs)

n_obs_long <- n_obs %>%
  pivot_longer(cols = c(Ovitrap, "BG-Trap"), 
               values_to = "n_obs", 
               names_to = "trap")

### pivot longer
forest_df_long <- left_join(boxplot_df_long, n_obs_long, 
                            by = c("cluster" = "cluster", 
                                   "month" = "month", "trap_type" = "trap"))
forest_df_long_2 <- forest_df_long %>%
  dplyr::select(cluster, month, trap_type, range, n_obs)

### add confidence intervals
forest_df_long_2$lower_CI <- NA
forest_df_long_2$upper_CI <- NA

for(i in 1:nrow(forest_df_long_2)){
  var <- forest_df_long_2$range[i]
  tot_tested <- forest_df_long_2$n_obs[i]
  n <- tot_tested - 1
  
  forest_df_long_2$lower_CI[i] <- (n*var)/qchisq(0.975, df = n)
  forest_df_long_2$upper_CI[i] <- (n*var)/qchisq(0.025, df = n)
}

forest_df_long_2 <- as.data.frame(forest_df_long_2)

### March plot
forest_df_long_2 %>%
  filter(month == "March") %>%
  ggplot(aes(y = fct_rev(cluster)))+
  geom_point(aes(x = range, color = trap_type), shape = 15, size = 3)+
  geom_linerange(aes(xmin = lower_CI, xmax = upper_CI, color = trap_type), alpha = 0.3)+
  geom_vline(xintercept = 0, linetype = "dashed")+
  scale_color_manual(values = c("red", "blue"), 
                    name = "Trap Type")+
  xlim(0, 1)+
  theme_classic()+
  xlab("Variance")+
  ylab("Cluster")+
  labs(title = "March")

### April plot
forest_df_long_2 %>%
  filter(month == "April") %>%
  ggplot(aes(y = fct_rev(cluster)))+
  geom_point(aes(x = range, color = trap_type), shape = 15, size = 3)+
  geom_linerange(aes(xmin = lower_CI, xmax = upper_CI, color = trap_type), alpha = 0.3)+
  geom_vline(xintercept = 0, linetype = "dashed")+
  scale_color_manual(values = c("red", "blue"), 
                    name = "Trap Type")+
  xlim(0, 1)+
  theme_classic()+
  xlab("Variance")+
  ylab("Cluster")+
  labs(title = "April")

### May plot
forest_df_long_2 %>%
  filter(month == "May") %>%
  ggplot(aes(y = fct_rev(cluster)))+
  geom_point(aes(x = range, color = trap_type), shape = 15, size = 3)+
  geom_linerange(aes(xmin = lower_CI, xmax = upper_CI, color = trap_type), alpha = 0.3)+
  geom_vline(xintercept = 0, linetype = "dashed")+
  scale_color_manual(values = c("red", "blue"), 
                    name = "Trap Type")+
  xlim(0, 1)+
  theme_classic()+
  xlab("Variance")+
  ylab("Cluster")+
  labs(title = "May")

```

## Sensitivity Analysis - bootstrap resampling
```{r - boostrap testing}
#cor.test(~ovitrap+bg, data = trap_results_final_3, method = "spearman") 

## ovitrap trap level - ovitrap_results_2
## bgtrap trap level - bgtrap_results_2

set.seed(123)

## min number of ovitraps per cluster per month
ovitraps_n <- ovitrap_results_2 %>%
  group_by(month, cluster) %>%
  summarize(n = n()) #3 - 36 

### plot distribution
viridis_pal <- c(viridis::viridis(n = 3))
months <- c("March" = viridis_pal[1], "April" = viridis_pal[2], "May" = viridis_pal[3])
  
ggplot(ovitraps_n, aes(x = n, group = month)) +
  geom_histogram(aes(fill = month, color = month)) +
  scale_color_manual(name = "Month", values = months)+
  scale_fill_manual(name = "Month", values = months)+
  labs(x = "Ovitraps per Cluster", y = "Frequency", 
       fill = "Month") +
  facet_wrap(~month)+
  theme_classic(base_size = 14)
#ggsave("supp_ovitrap_distribution.jpeg", dpi = 1200, height = 5, width = 15)

## min number of bg-traps per cluster per month
bgtraps_n <- bgtrap_results_2 %>%
  group_by(month, cluster) %>%
  summarize(n = n()) #3 - 22

ggplot(bgtraps_n, aes(x = n, group = month)) +
  geom_histogram(aes(fill = month, color = month)) +
  scale_color_manual(name = "Month", values = months)+
  scale_fill_manual(name = "Month", values = months)+
  xlim(0, 36)+
  ylim(0, 6)+
  labs(x = "BG-Traps per Cluster", y = "Frequency", 
       fill = "Month") +
  facet_wrap(~month)+
  theme_classic(base_size = 14)
ggsave("supp_bgtrap_distribution.jpeg", dpi = 1200, height = 5, width = 15)
```

### 3 Traps per Cluster
```{r}
## Bootstrap loop
n_boot <- 10000

results_3 <- data.frame(iter = 1:n_boot, rho = NA, p_value = NA)

for (i in 1:n_boot) {
  sampled_ovi <- ovitrap_results_2 %>%
    group_by(month, cluster) %>%
    slice_sample(n = 3) %>%
    summarize(cluster_prev_ovi = mean(trap_prop, na.rm = TRUE), 
              tot_aedes_ovi = sum(n_larvae, na.rm = TRUE), 
              tot_wmel_ovi = sum(n_wmel, na.rm = TRUE),
              .groups = "drop")
  
  sampled_bg <- bgtrap_results_2 %>%
    group_by(month, cluster) %>%
    slice_sample(n = 3) %>%
    summarize(cluster_prev_bg = mean(trap_prop, na.rm = TRUE), 
              tot_aedes_bg = sum(total_aegypti_caught, na.rm = TRUE), 
              tot_wmel_bg = sum(screening_wmel_aeg, na.rm = TRUE),
              .groups = "drop")
  
  sampled_df <- left_join(sampled_bg, sampled_ovi, by = c("cluster","month")) %>%
    group_by(cluster) %>%
    arrange(month, .by_group = TRUE)
  
  corr <- cor.test(~ cluster_prev_ovi + cluster_prev_bg, 
                   data = sampled_df, method = "spearman")
  
  results_3$rho[i] <- unname(corr$estimate)
  results_3$p_value[i] <- corr$p.value
}

### plot rho distribution
rho_mean <- mean(results_3$rho, na.rm = TRUE) # 0.6048486
rho_ci <- quantile(results_3$rho, probs = c(0.025, 0.975), na.rm = TRUE) # 0.4364182 0.7571468

ggplot(results_3, aes(x = rho)) +
  geom_histogram(fill = "skyblue", color = "white", bins = 30) +
  geom_vline(xintercept = rho_mean, color = "red", size = 1, linetype = "dashed") +
  geom_vline(xintercept = rho_ci, color = "darkgreen", size = 1, linetype = "dotted") +
  labs(x = "Spearman-rank Correlation Coefficient", y = "Frequency", 
       title = "Sampling 3 Traps per Cluster") +
  theme_classic(base_size = 14)+
  coord_cartesian(xlim = c(0, 1), ylim = c(0, 1200))
ggsave("supp_bootstrap_corr_3.jpeg", dpi = 1200)

```

### 5 Traps per Cluster
```{r}
## Bootstrap loop
n_boot <- 10000

results_5 <- data.frame(iter = 1:n_boot, rho = NA, p_value = NA)

for (i in 1:n_boot) {
  sampled_ovi <- ovitrap_results_2 %>%
    group_by(month, cluster) %>%
    group_modify(~ { if (nrow(.x) >= 5) {
      .x %>% slice_sample(n = 5, replace = FALSE)} else {
      .x %>% slice_sample(n = 5, replace = TRUE)}}) %>%
    summarize(cluster_prev_ovi = mean(trap_prop, na.rm = TRUE), 
              tot_aedes_ovi = sum(n_larvae, na.rm = TRUE), 
              tot_wmel_ovi = sum(n_wmel, na.rm = TRUE),
              .groups = "drop")
  
  sampled_bg <- bgtrap_results_2 %>%
    group_by(month, cluster) %>%
    group_modify(~ { if (nrow(.x) >= 5) {
      .x %>% slice_sample(n = 5, replace = FALSE)} else {
      .x %>% slice_sample(n = 5, replace = TRUE)}}) %>%
    summarize(cluster_prev_bg = mean(trap_prop, na.rm = TRUE), 
              tot_aedes_bg = sum(total_aegypti_caught, na.rm = TRUE), 
              tot_wmel_bg = sum(screening_wmel_aeg, na.rm = TRUE),
              .groups = "drop")
  
  sampled_df <- left_join(sampled_bg, sampled_ovi, by = c("cluster","month")) %>%
    group_by(cluster) %>%
    arrange(month, .by_group = TRUE)
  
  corr <- cor.test(~ cluster_prev_ovi + cluster_prev_bg, 
                   data = sampled_df, method = "spearman")
  
  results_5$rho[i] <- unname(corr$estimate)
  results_5$p_value[i] <- corr$p.value
}

### plot rho distribution
rho_mean <- mean(results_5$rho, na.rm = TRUE) # 0.6506806
rho_ci <- quantile(results_5$rho, probs = c(0.025, 0.975), na.rm = TRUE) # 0.5196615 0.7721001 

ggplot(results_5, aes(x = rho)) +
  geom_histogram(fill = "skyblue", color = "white", bins = 30) +
  geom_vline(xintercept = rho_mean, color = "red", size = 1, linetype = "dashed") +
  geom_vline(xintercept = rho_ci, color = "darkgreen", size = 1, linetype = "dotted") +
  labs(x = "Spearman-rank Correlation Coefficient", y = "Frequency", 
       title = "Sampling 5 Traps per Cluster") +
  theme_classic(base_size = 14)+
  coord_cartesian(xlim = c(0, 1), ylim = c(0, 1200))
ggsave("supp_bootstrap_corr_5.jpeg", dpi = 1200)

```

### 6 Traps per Cluster
```{r}
## Bootstrap loop
n_boot <- 10000

results_6 <- data.frame(iter = 1:n_boot, rho = NA, p_value = NA)

for (i in 1:n_boot) {
  sampled_ovi <- ovitrap_results_2 %>%
    group_by(month, cluster) %>%
    group_modify(~ { if (nrow(.x) >= 6) {
      .x %>% slice_sample(n = 6, replace = FALSE)} else {
      .x %>% slice_sample(n = 6, replace = TRUE)}}) %>%
    summarize(cluster_prev_ovi = mean(trap_prop, na.rm = TRUE), 
              tot_aedes_ovi = sum(n_larvae, na.rm = TRUE), 
              tot_wmel_ovi = sum(n_wmel, na.rm = TRUE),
              .groups = "drop")
  
  sampled_bg <- bgtrap_results_2 %>%
    group_by(month, cluster) %>%
    group_modify(~ { if (nrow(.x) >= 6) {
      .x %>% slice_sample(n = 6, replace = FALSE)} else {
      .x %>% slice_sample(n = 6, replace = TRUE)}}) %>%
    summarize(cluster_prev_bg = mean(trap_prop, na.rm = TRUE), 
              tot_aedes_bg = sum(total_aegypti_caught, na.rm = TRUE), 
              tot_wmel_bg = sum(screening_wmel_aeg, na.rm = TRUE),
              .groups = "drop")
  
  sampled_df <- left_join(sampled_bg, sampled_ovi, by = c("cluster","month")) %>%
    group_by(cluster) %>%
    arrange(month, .by_group = TRUE)
  
  corr <- cor.test(~ cluster_prev_ovi + cluster_prev_bg, 
                   data = sampled_df, method = "spearman")
  
  results_6$rho[i] <- unname(corr$estimate)
  results_6$p_value[i] <- corr$p.value
}

### plot rho distribution
rho_mean <- mean(results_6$rho, na.rm = TRUE) # 0.6625991
rho_ci <- quantile(results_6$rho, probs = c(0.025, 0.975), na.rm = TRUE) # 0.5436989 0.7760384

ggplot(results_6, aes(x = rho)) +
  geom_histogram(fill = "skyblue", color = "white", bins = 30) +
  geom_vline(xintercept = rho_mean, color = "red", size = 1, linetype = "dashed") +
  geom_vline(xintercept = rho_ci, color = "darkgreen", size = 1, linetype = "dotted") +
  labs(x = "Spearman-rank Correlation Coefficient", y = "Frequency", 
       title = "Sampling 6 Traps per Cluster") +
  theme_classic(base_size = 14)+
  coord_cartesian(xlim = c(0, 1), ylim = c(0, 1200))
#ggsave("supp_bootstrap_corr_6.jpeg", dpi = 1200)

```

### 9 Traps per Cluster
```{r}
## Bootstrap loop
n_boot <- 10000

results_9 <- data.frame(iter = 1:n_boot, rho = NA, p_value = NA)

for (i in 1:n_boot) {
  sampled_ovi <- ovitrap_results_2 %>%
    group_by(month, cluster) %>%
    group_modify(~ { if (nrow(.x) >= 9) {
      .x %>% slice_sample(n = 9, replace = FALSE)} else {
      .x %>% slice_sample(n = 9, replace = TRUE)}}) %>%
    summarize(cluster_prev_ovi = mean(trap_prop, na.rm = TRUE), 
              tot_aedes_ovi = sum(n_larvae, na.rm = TRUE), 
              tot_wmel_ovi = sum(n_wmel, na.rm = TRUE),
              .groups = "drop")
  
  sampled_bg <- bgtrap_results_2 %>%
    group_by(month, cluster) %>%
    group_modify(~ { if (nrow(.x) >= 9) {
      .x %>% slice_sample(n = 9, replace = FALSE)} else {
      .x %>% slice_sample(n = 9, replace = TRUE)}}) %>%
    summarize(cluster_prev_bg = mean(trap_prop, na.rm = TRUE), 
              tot_aedes_bg = sum(total_aegypti_caught, na.rm = TRUE), 
              tot_wmel_bg = sum(screening_wmel_aeg, na.rm = TRUE),
              .groups = "drop")
  
  sampled_df <- left_join(sampled_bg, sampled_ovi, by = c("cluster","month")) %>%
    group_by(cluster) %>%
    arrange(month, .by_group = TRUE)
  
  corr <- cor.test(~ cluster_prev_ovi + cluster_prev_bg, 
                   data = sampled_df, method = "spearman")
  
  results_9$rho[i] <- unname(corr$estimate)
  results_9$p_value[i] <- corr$p.value
}

### plot rho distribution
rho_mean <- mean(results_9$rho, na.rm = TRUE) # 0.6751634
rho_ci <- quantile(results_9$rho, probs = c(0.025, 0.975), na.rm = TRUE) # 0.5746814 0.7708674

ggplot(results_9, aes(x = rho)) +
  geom_histogram(fill = "skyblue", color = "white", bins = 30) +
  geom_vline(xintercept = rho_mean, color = "red", size = 1, linetype = "dashed") +
  geom_vline(xintercept = rho_ci, color = "darkgreen", size = 1, linetype = "dotted") +
  labs(x = "Spearman-rank Correlation Coefficient", y = "Frequency", 
       title = "Sampling 9 Traps per Cluster") +
  theme_classic(base_size = 14)+
  coord_cartesian(xlim = c(0, 1), ylim = c(0, 1200))
ggsave("supp_bootstrap_corr_9.jpeg", dpi = 1200)

```

### 12 Traps per Cluster
```{r}
## Bootstrap loop
n_boot <- 10000

results_12 <- data.frame(iter = 1:n_boot, rho = NA, p_value = NA)

for (i in 1:n_boot) {
  sampled_ovi <- ovitrap_results_2 %>%
    group_by(month, cluster) %>%
    group_modify(~ { if (nrow(.x) >= 12) {
      .x %>% slice_sample(n = 12, replace = FALSE)} else {
      .x %>% slice_sample(n = 12, replace = TRUE)}}) %>%
    summarize(cluster_prev_ovi = mean(trap_prop, na.rm = TRUE), 
              tot_aedes_ovi = sum(n_larvae, na.rm = TRUE), 
              tot_wmel_ovi = sum(n_wmel, na.rm = TRUE),
              .groups = "drop")
  
  sampled_bg <- bgtrap_results_2 %>%
    group_by(month, cluster) %>%
    group_modify(~ { if (nrow(.x) >= 12) {
      .x %>% slice_sample(n = 12, replace = FALSE)} else {
      .x %>% slice_sample(n = 12, replace = TRUE)}}) %>%
    summarize(cluster_prev_bg = mean(trap_prop, na.rm = TRUE), 
              tot_aedes_bg = sum(total_aegypti_caught, na.rm = TRUE), 
              tot_wmel_bg = sum(screening_wmel_aeg, na.rm = TRUE),
              .groups = "drop")
  
  sampled_df <- left_join(sampled_bg, sampled_ovi, by = c("cluster","month")) %>%
    group_by(cluster) %>%
    arrange(month, .by_group = TRUE)
  
  corr <- cor.test(~ cluster_prev_ovi + cluster_prev_bg, 
                   data = sampled_df, method = "spearman")
  
  results_12$rho[i] <- unname(corr$estimate)
  results_12$p_value[i] <- corr$p.value
}

### plot rho distribution
rho_mean <- mean(results_12$rho, na.rm = TRUE) # 0.6723427
rho_ci <- quantile(results_12$rho, probs = c(0.025, 0.975), na.rm = TRUE) # 0.5657083 0.7746815

ggplot(results_12, aes(x = rho)) +
  geom_histogram(fill = "skyblue", color = "white", bins = 30) +
  geom_vline(xintercept = rho_mean, color = "red", size = 1, linetype = "dashed") +
  geom_vline(xintercept = rho_ci, color = "darkgreen", size = 1, linetype = "dotted") +
  labs(x = "Spearman-rank Correlation Coefficient", y = "Frequency", 
       title = "Sampling 12 Traps per Cluster") +
  theme_classic(base_size = 14)+
  coord_cartesian(xlim = c(0, 1), ylim = c(0, 1200))
ggsave("supp_bootstrap_corr_12.jpeg", dpi = 1200)

```

## Sensitivity Analysis - correlation between ovitraps and BG-traps as a function of the number of mosquitoes tested.
* Correlation weighted by number of mosquitoes tested
```{r}
## Stratify by number of mosquitoes tested
### Create categories of number tested
quantiles <- quantile(trap_results_final$ovitrap_tot_tested, probs = c(0, 1/3, 2/3, 1), na.rm = TRUE)

trap_results_final <- trap_results_final %>%
  mutate(
    strata = cut(ovitrap_tot_tested,
                 breaks = quantiles,
                 include.lowest = TRUE,
                 labels = c("Low", "Medium", "High"))
  )

trap_results_final %>%
  group_by(strata) %>%
  summarize(range = range(ovitrap_tot_tested))

### Run Spearman-rank on each strata
results <- trap_results_final %>%
  filter(!(is.na(strata))) %>%
  group_by(strata) %>%
  summarise(
    n = n(),
    spearman_result = list(cor.test(ovitrap, bg, method = "spearman")),
    .groups = "drop"
  ) %>%
  mutate(
    estimate = purrr::map_dbl(spearman_result, ~ .x$estimate[[1]]),
    p_value  = purrr::map_dbl(spearman_result, ~ .x$p.value)
  ) %>%
  dplyr::select(strata, n, estimate, p_value)

```

* Linear association: wMel prevalence in BG-traps = β0 + β1 × wMel prevalence in ovitraps + β2 × mosquitoes tested+ϵ
```{r}
sens_mod_1 <- glmer.nb(n_wmel_bg ~ ovitrap + n_tested_ovi + (1|cluster) + 
                  offset(log(total_caught)),  
                  na.action=na.exclude, data = model3_df)

sens_mod_2 <- glmer.nb(n_wmel_bg ~ ovitrap*n_tested_ovi + (1|cluster) + 
                  offset(log(total_caught)),  
                  na.action=na.exclude, data = model3_df)

sens_mod_3 <- glm.nb(n_wmel_bg ~ ovitrap + n_tested_ovi + 
                  offset(log(total_caught)),  
                  na.action=na.exclude, data = model3_df)

sens_mod_4 <- glm.nb(n_wmel_bg ~ ovitrap*n_tested_ovi + 
                  offset(log(total_caught)),  
                  na.action=na.exclude, data = model3_df)

summary(sens_mod_4)

```



## Supplemental Figure - trap-level data
```{r}
## ovitraps 
ovitrap_results_2 <- ovitrap_results_2 %>%
  mutate(month = str_to_title(month), 
         month = factor(month, levels = c("March", "April", "May")))

ovi_clust <- trap_results_final_2 %>%
  dplyr::select(cluster, month, ovitrap) %>%
  rename(cluster_prev = ovitrap)

ovi_clust_trap <- left_join(ovitrap_results_2, ovi_clust, by = c("cluster" = "cluster", 
                                                                 "month" = "month"))
viridis_pal <- c(viridis::viridis(n = 3))
months <- c("March" = viridis_pal[1], "April" = viridis_pal[2], "May" = viridis_pal[3])

## plot
ovi_clust_trap %>%
  ggplot()+
  geom_point(aes(cluster_prev, trap_prop, size = n_larvae, color = month))+
  labs(x = "Cluster-level wMel Prevalence", 
       y = "Trap-level wMel Prevalene", 
       color = "Month", 
       size = "Aedes Larvae Caught")+ 
  theme_classic()+
  scale_color_manual(name = "Month", values = months)+
   theme(aspect.ratio = 1)
#ggsave("supp_ovi_trap_prev_dots.jpeg", dpi = 1200)


## bg-traps
bgtrap_results_2 <- bgtrap_results_2 %>%
  mutate(month = str_to_title(month), 
         month = factor(month, levels = c("March", "April", "May")))

bg_clust <- trap_results_final_2 %>%
  dplyr::select(cluster, month, bg) %>%
  rename(cluster_prev = bg)

bg_clust_trap <- left_join(bgtrap_results_2, bg_clust, by = c("cluster" = "cluster", 
                                                                 "month" = "month"))


### prevalence
bg_clust_trap %>%
  ggplot()+
  geom_point(aes(cluster_prev, trap_prop, size = total_aegypti_caught, color = month))+
  labs(x = "Cluster-level wMel Prevalence", 
       y = "Trap-level wMel Prevalene", 
       color = "Month", 
       size = "Aedes aegpti Adults Caught")+ 
  theme_classic()+
  scale_color_manual(name = "Month", values = months)+
   theme(aspect.ratio = 1)
#ggsave("supp_bg_trap_prev_dots.jpeg", dpi = 1200)



```

